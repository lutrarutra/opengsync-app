{% from "components/status_bar.jinja2" import seq_request_status_bar with context %}
{% from "components/assignee_list.jinja2" import assignee_list %}
{% from "components/tooltip.jinja2" import tooltip %}

<div class="modal-content assay-type-todo-container">
    <div class="modal-header">
        <h1 class="modal-title fs-5">{{ service_type.abbreviation }}</h1>
        <button type="button" class="btn-close" aria-label="Close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
        <div class="banner-container">
            {% for _, row in df.iterrows() %}
            {% set seq_request = row["seq_request"] %}
            <div class="element-banner">
                <div class="row">
                    <div class="col-6"><a href="{{ url_for('seq_requests_page.seq_request', seq_request_id=seq_request.id) }}">BSR_{{ "%04d" | format(seq_request.id) }}</a> {% if seq_request.assignees %} - {{ assignee_list(seq_request.assignees, current_user=current_user) }}{% endif %}</div>
                    <div class="col-6">
                        {% if current_user not in seq_request.assignees %}
                        <button type="button" {{ tooltip("Assign yourself", category="success", position="left") }} class="btn" hx-post="{{ url_for('seq_requests_htmx.add_assignee', seq_request_id=seq_request.id, assignee_id=current_user.id) }}"><i class="bi bi-person-fill-add"></i></button>
                        {% endif %}
                        <span class="badge">{{ seq_request.timestamp_submitted_str("%-d. %b.") }}</span>
                        <span class="badge">{{ seq_request.submission_type.display_name }}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-8"><b>{{ seq_request.requestor.name }}</b>: <i>{{ seq_request.name }}</i></div>
                    <div class="col-4"><span class="badge">Libraries: {{ seq_request.num_libraries }}</span></div>
                </div>
                <div class="row pb-1">
                    <div class="col-6">
                        {% for library_type, count in row["library_type_counts"].items() %}
                        <span class="badge">{{ library_type.abbreviation }}: {{ count }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-6">
                        {% if seq_request.submission_type == SubmissionType.RAW_SAMPLES %}
                        <span class="badge {% if row['num_waiting_samples'] == 0 %}badge-success{% else %}badge-warning{% endif %}">
                            Waiting Samples: {{ row["num_waiting_samples"] }}  ðŸ“­
                        </span>
                        {% elif seq_request.submission_type == SubmissionType.UNPOOLED_LIBRARIES %}
                        <span class="badge {% if row['num_waiting_libraries'] == 0 %}badge-success{% else %}badge-warning{% endif %}">
                            Waiting Libraries: {{ row["num_waiting_libraries"] }}  ðŸ“­
                        </span>
                        {% else %}
                        <span class="badge {% if row['num_waiting_pools'] == seq_request.num_pools %}badge-success{% else %}badge-warning{% endif %}">
                            Waiting Pools: {{ row["num_waiting_pools"] }}  ðŸ“­
                        </span>
                        {% endif %}
                        <span class="badge {% if row['num_preparing_libraries'] == 0 %}badge-success{% else %}badge-warning{% endif %}">
                            Preparing Libraries: {{ row["num_preparing_libraries"] }} {{ LibraryStatus.PREPARING.icon }}
                        </span>
                        <span class="badge {% if row['num_pooled_libraries'] == seq_request.num_libraries %}badge-success{% else %}badge-warning{% endif %}">
                            Pooled Libraries: {{ row["num_pooled_libraries"] }} {{ LibraryStatus.POOLED.icon }}
                        </span>
                    </div>
                </div>
                {{ seq_request_status_bar(seq_request) }}
            </div>
            {% endfor %}
        </div>
    </div>
</div>