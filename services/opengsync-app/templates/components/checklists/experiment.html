{% from "components/spinner.jinja2" import spinner %}

<div class="accordion p-1" id="sops-accordion">
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sops-accordiod-collapse-1" aria-expanded="false" aria-controls="sops-accordiod-collapse-1">
                <b>{% if pools_added %}‚úÖ{% else %}‚ö†Ô∏è{% endif %} Add Pools to the Experiment</b>
            </button>
        </h2>
        <div id="sops-accordiod-collapse-1" class="accordion-collapse collapse collapsed" data-bs-parent="#sops-accordion">
            <div class="accordion-body">
                <b>Steps:</b>
                <ol>
                    <li>
                        <button class="btn-primary btn" hx-get="{{ url_for('select_experiment_pools_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#xl-modal-content" data-bs-toggle="modal"
                        data-bs-target="#xl-modal">Begin</button> 'Add Pools' - Workflow
                    </li>
                    <li>Select pools</li>
                    <li>Complete workflow</li>
                </ol>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sops-accordiod-collapse-2" aria-expanded="false" aria-controls="sops-accordiod-collapse-2">
                <b>{% if lanes_assigned is none %}‚ùó{% elif lanes_assigned %}‚úÖ{% else %}‚ö†Ô∏è{% endif %} Assign Lane to each pool</b>
            </button>
        </h2>
        <div id="sops-accordiod-collapse-2" class="accordion-collapse collapse collapsed" data-bs-parent="#sops-accordion">
            <div class="accordion-body">
                <b>Steps:</b>
                <ol>
                    <li>In <b>'Pools'</b>-tab, select lane(s) for each pool.</li>
                </ol>
                {% if not lanes_assigned %}
                <b>Pools without lane:</b>
                <ul>
                    {% for pool in experiment.pools %}
                    {% if not pool.lane_links %}
                    <li>{{ pool.name }}</li>
                    {% endif %}
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sops-accordiod-collapse-3" aria-expanded="false" aria-controls="sops-accordiod-collapse-3">
                <b>{% if lanes_assigned is none %}‚ùó{% else %}üîò{% endif %} Check Barcode Clashes</b>
            </button>
        </h2>
        <div id="sops-accordiod-collapse-3" class="accordion-collapse collapse collapsed" data-bs-parent="#sops-accordion">
            <div class="accordion-body">
                <b>Steps:</b>
                <ol>
                    <li>
                        <button class="btn-primary btn" data-bs-toggle="modal" data-bs-target="#fullscreen-modal"
                    hx-get="{{ url_for('check_barcode_clashes_workflow.check_experiment_barcode_clashes', experiment_id=experiment.id) }}"
                    hx-target="#fullscreen-modal-content" hx-swap="innerHTML" {% if lanes_assigned is none %}disabled{% endif %}>Check Clashes</button>
                    </li>
                </ol>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sops-accordiod-collapse-4" aria-expanded="false" aria-controls="sops-accordiod-collapse-4">
                <b>{% if reads_assigned is none %}‚ùó{% elif reads_assigned %}‚úÖ{% else %}‚ö†Ô∏è{% endif %} Assign Target Number of Reads to be Sequenced for each Pool</b>
            </button>
        </h2>
        <div id="sops-accordiod-collapse-4" class="accordion-collapse collapse collapsed" data-bs-parent="#sops-accordion">
            <div class="accordion-body">
                <b>Steps:</b>
                <ol>
                    <li>
                    <button class="btn-primary btn" 
                        hx-get="{{ url_for('dist_reads_workflow.begin', experiment_id=experiment.id) }}" hx-target="#xl-modal-content"
                        hx-swap="innerHTML" data-bs-toggle="modal" data-bs-target="#xl-modal" {% if reads_assigned is none %}disabled{% endif %}>Assign</button> reads to each pool
                    </li>
                </ol>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <th scope="col">Pool</th>
                            <th>Lane</th>
                            <th>Reads</th>
                            <th>Lane Share</th>
                            <th>Flowcell Share</th>
                        </thead>
                        <tbody>
                            {% for lane in experiment.lanes %}
                            {% for link in lane.pool_links %}
                            <tr>
                                <th scope="row">{{ link.pool.name }}</th>
                                <th>{{ link.lane_num }}</th>
                                <td>
                                    <div class="quantity-container">
                                        <div class="value">{{ link.num_m_reads }}</div>
                                        <div class="unit">M</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="quantity-container">
                                        <div class="value">{% if link.num_m_reads %}{{ "%.1f" | format(100 * link.num_m_reads / lane.get_loaded_reads()) if lane.get_loaded_reads() else "" }}{% endif %}</div>
                                        <div class="unit">%</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="quantity-container">
                                        <div class="value">{% if link.num_m_reads %}{{ "%.1f" | format(100 * link.num_m_reads / experiment.get_loaded_reads()) if experiment.get_loaded_reads() else "" }}{% endif %}</div>
                                        <div class="unit">%</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sops-accordiod-collapse-5" aria-expanded="false" aria-controls="sops-accordiod-collapse-5">
                <b>{% if pool_qubits_measured is none %}‚ùó{% elif pool_qubits_measured %}‚úÖ{% else %}‚ö†Ô∏è{% endif %} Measure Qubit for each Pool</b>
            </button>
        </h2>
        <div id="sops-accordiod-collapse-5" class="accordion-collapse collapse collapsed" data-bs-parent="#sops-accordion">
            <div class="accordion-body">
                <b>Steps:</b>
                <ol>
                    <li>
                        <button class="btn-primary btn"
                        data-bs-toggle="modal" data-bs-target="#xl-modal" 
                        hx-get="{{ url_for('qubit_measure_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#xl-modal-content" data-bs-toggle="modal"
                        hx-swap="innerHTML" hx-trigger="click" {% if pool_qubits_measured is none %}disabled{% endif %}>Begin</button> 'Qubit Concentration' - Workflow
                    </li>
                </ol>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <th scope="col">Pool</th>
                            <th>Qubit Concentration</th>
                        </thead>
                        <tbody>
                        {% for pool in experiment.pools %}
                            <tr>
                                <th scope="row">{{ pool.name }}</th>
                                <td>
                                    <div class="quantity-container">
                                        <div class="value">{{ pool.qubit_concentration }}</div>
                                        <div class="unit">ng/ŒºL</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sops-accordiod-collapse-6" aria-expanded="false" aria-controls="sops-accordiod-collapse-6">
                <b>{% if pool_fragment_sizes_measured is none %}‚ùó{% elif pool_fragment_sizes_measured %}‚úÖ{% else %}‚ö†Ô∏è{% endif %} Measure Pool Fragment Size (BA)</b>
            </button>
        </h2>
        <div id="sops-accordiod-collapse-6" class="accordion-collapse collapse collapsed" data-bs-parent="#sops-accordion">
            <div class="accordion-body">
                <b>Steps:</b>
                <ol>
                    <li>
                        <button class="btn-primary btn"
                        data-bs-toggle="modal" data-bs-target="#xl-modal" 
                        hx-get="{{ url_for('ba_report_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#xl-modal-content" data-bs-toggle="modal"
                        hx-swap="innerHTML" hx-trigger="click" {% if pool_fragment_sizes_measured is none %}disabled{% endif %}>Begin</button> 'Bio Analyzer Report' - Workflow
                    </li>
                </ol>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <th scope="col" class="col-2">Pool</th>
                            <th class="col-2">Average Fragment Size</th>
                            <th class="col-8">Report</th>
                        </thead>
                        <tbody>
                        {% for pool in experiment.pools %}
                            <tr>
                                <th scope="row">{{ pool.name }}</th>
                                <td>
                                    <div class="quantity-container">
                                        <div class="value">{{ pool.avg_fragment_size }}</div>
                                        <div class="unit">bp</div>
                                    </div>
                                </td>
                                <td class="x-scroll-cell">
                                    <span class="scroll-container">{% if pool.ba_report_id %}<span class="desc">{{ pool.ba_report.timestamp | format_datetime }}</span> <a href="{{ url_for('pdf_file', file_id=pool.ba_report_id) }}" target="_blank">{{ pool.ba_report.name }}</a></span>{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sops-accordiod-collapse-7" aria-expanded="false" aria-controls="sops-accordiod-collapse-7">
                <b>{% if lanes_assigned is none %}‚ùó{% else %}üîò{% endif %} Dilute Pools for Pooling (Optional)</b>
            </button>
        </h2>
        <div id="sops-accordiod-collapse-7" class="accordion-collapse collapse collapsed" data-bs-parent="#sops-accordion">
            <div class="accordion-body">
                <b>Steps:</b>
                <ol>
                    <li>
                        <button class="btn-primary btn"
                        data-bs-toggle="modal" data-bs-target="#fullscreen-modal"
                        hx-get="{{ url_for('dilute_pools_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#fullscreen-modal-content" hx-swap="innerHTML" {% if lanes_assigned is none %}disabled{% endif %}>Begin</button> 'Dilute Pools' - Workflow.
                    </li>
                </ol>
                <div hx-get="{{ url_for('experiments_htmx.get_pool_dilutions', experiment_id=experiment.id) }}" hx-trigger="intersect once">
                    {{ spinner() }}
                </div>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sops-accordiod-collapse-8" aria-expanded="false" aria-controls="sops-accordiod-collapse-8">
                <b>{% if laning_completed is none %}‚ùó{% elif laning_completed %}‚úÖ{% else %}‚ö†Ô∏è{% endif %} Lane Pools (Pooling into Lanes)</b>
            </button>
        </h2>
        <div id="sops-accordiod-collapse-8" class="accordion-collapse collapse collapsed" data-bs-parent="#sops-accordion">
            <div class="accordion-body">
                <b>Steps:</b>
                <ol>
                    <li>
                        <button class="btn-primary btn"
                        data-bs-toggle="modal" data-bs-target="#fullscreen-modal"
                        hx-get="{{ url_for('lane_pools_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#fullscreen-modal-content" hx-swap="innerHTML" {% if laning_completed is none %}disabled{% endif %}>Begin</button> 'Lane Pools' - Workflow.
                    </li>
                </ol>
                <b>Notes:</b>
                <ul>
                    <li>Optional when all lanes have only one pool.</li>
                </ul>
                {% if experiment.lane_pooling_table %}
                <div class="file-container">
                    <div hx-get="{{ url_for('experiments_htmx.render_lane_sample_pooling_tables', file_id=experiment.lane_pooling_table.id, experiment_id=experiment.id) }}" hx-trigger="intersect once">
                        {{ spinner() }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sops-accordiod-collapse-9" aria-expanded="false" aria-controls="sops-accordiod-collapse-9">
                <b>{% if lane_qubit_measured is none %}‚ùó{% elif lane_qubit_measured %}‚úÖ{% else %}‚ö†Ô∏è{% endif %} Measure Qubit for each Lane</b>
            </button>
        </h2>
        <div id="sops-accordiod-collapse-9" class="accordion-collapse collapse collapsed" data-bs-parent="#sops-accordion">
            <div class="accordion-body">
                <b>Steps:</b>
                <ol>
                    <li>
                        <button class="btn-primary btn"
                        data-bs-toggle="modal" data-bs-target="#xl-modal" 
                        hx-get="{{ url_for('qubit_measure_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#xl-modal-content" data-bs-toggle="modal"
                        hx-swap="innerHTML" hx-trigger="click" {% if lane_qubit_measured is none %}disabled{% endif %}>Begin</button> 'Qubit Concentration' - Workflow
                    </li>
                    <li>Select lanes from 'Lanes'-tab</li>
                </ol>
                <b>Notes:</b>
                <ul>
                    <li>Optional when all lanes have only one pool; lane Qubit concentration is assumed to be the pool's Qubit concentration.</li>
                </ul>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <th scope="col">Lane</th>
                            <th>Qubit Concentration</th>
                        </thead>
                        <tbody>
                        {% for lane in experiment.lanes %}
                            <tr>
                                <th scope="row">{{ lane.number }}</th>
                                <td>
                                    <div class="quantity-container">
                                        <div class="value">
                                            {% if lane.original_qubit_concentration is not none %}
                                            {{ lane.original_qubit_concentration }}
                                            {% elif lane.pool_links | length == 1 %}
                                            <span class="desc">pool</span> {{ lane.pool_links[0].pool.qubit_concentration }}
                                            {% endif %}
                                        </div>
                                        <div class="unit">ng/ŒºL</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sops-accordiod-collapse-10" aria-expanded="false" aria-controls="sops-accordiod-collapse-10">
                <b>{% if lane_fragment_size_measured is none %}‚ùó{% elif lane_fragment_size_measured %}‚úÖ{% else %}‚ö†Ô∏è{% endif %} Measure Lane Fragment Size (BA)</b>
            </button>
        </h2>
        <div id="sops-accordiod-collapse-10" class="accordion-collapse collapse collapsed" data-bs-parent="#sops-accordion">
            <div class="accordion-body">
                <b>Steps:</b>
                <ol>
                    <li>
                        <button class="btn-primary btn"
                        data-bs-toggle="modal" data-bs-target="#xl-modal" 
                        hx-get="{{ url_for('ba_report_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#xl-modal-content" data-bs-toggle="modal"
                        hx-swap="innerHTML" hx-trigger="click" {% if lane_fragment_size_measured is none %}disabled{% endif %}>Begin</button> 'Bio Analyzer Report' - Workflow
                    </li>
                    <li>Select lanes from 'Lanes'-tab</li>
                </ol>
                <b>Notes:</b>
                <ul>
                    <li>Optional when all lanes have only one pool; lane fragment size is assumed to be the pool's fragment size.</li>
                </ul>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <th scope="col" class="col-1">Lane</th>
                            <th class="col-2">Avg. Fragment Size</th>
                            <th class="col-9">Report</th>
                        </thead>
                        <tbody>
                        {% for lane in experiment.lanes %}
                            <tr>
                                <th scope="row">{{ lane.number }}</th>
                                <td>
                                    <div class="quantity-container">
                                        <div class="value">
                                            {% if lane.avg_fragment_size is not none %}
                                            {{ lane.avg_fragment_size }}
                                            {% elif lane.pool_links | length == 1 %}
                                            <span class="desc">pool</span> {{ lane.pool_links[0].pool.avg_fragment_size }}
                                            {% endif %}
                                        </div>
                                        <div class="unit">bp</div>
                                    </div>
                                </td>
                                <td class="x-scroll-cell">
                                    {% if lane.ba_report_id %}
                                    <span class="scroll-container">
                                        <span class="desc">{{ lane.ba_report.timestamp | format_datetime }}</span>
                                        <a href="{{ url_for('pdf_file', file_id=lane.ba_report_id) }}" target="_blank">{{ lane.ba_report.name }}</a>
                                    </span>
                                    {% elif lane.pool_links | length == 1 and lane.pool_links[0].pool.ba_report_id %}
                                    <span class="scroll-container">
                                        <span class="desc">{{ lane.pool_links[0].pool.ba_report.timestamp | format_datetime }}</span>
                                        <a href="{{ url_for('pdf_file', file_id=lane.pool_links[0].pool.ba_report_id) }}" target="_blank">{{ lane.pool_links[0].pool.ba_report.name }}</a>
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sops-accordiod-collapse-11" aria-expanded="false" aria-controls="sops-accordiod-collapse-11">
                <b>{% if flowcell_loaded is none %}‚ùó{% elif flowcell_loaded %}‚úÖ{% else %}‚ö†Ô∏è{% endif %} Load Flowcell</b>
            </button>
        </h2>
        <div id="sops-accordiod-collapse-11" class="accordion-collapse collapse collapsed" data-bs-parent="#sops-accordion">
            <div class="accordion-body">
                <b>Steps:</b>
                <ol>
                    <li>
                        <button class="btn-primary btn"
                        data-bs-toggle="modal" data-bs-target="#fullscreen-modal"
                        hx-get="{{ url_for('load_flow_cell_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#fullscreen-modal-content" hx-swap="innerHTML" {% if flowcell_loaded is none %}disabled{% endif %}>Begin</button> 'Load Flow Cell' - Workflow.
                    </li>
                </ol>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <th scope="col">Lane</th>
                            <th>Sequencing Concentration</th>
                            <th>Library Volume</th>
                            <th>Total Volume</th>
                            <th>Target Molarity</th>
                            <th>Phi X %</th>
                        </thead>
                        <tbody>
                            {% for lane in experiment.lanes %}
                            <tr>
                                <th scope="row">{{ lane.number }}</th>
                                <td>
                                    <div class="quantity-container">
                                        <div class="value">{{ "%.4f" | format(lane.sequencing_qubit_concentration) if lane.sequencing_qubit_concentration is not none else "" }}</div>
                                        <div class="unit">ng/ŒºL</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="quantity-container">
                                        <div class="value">{{ "%.2f" | format(lane.library_volume_ul) if lane.library_volume_ul is not none else "" }}</div>
                                        <div class="unit">ŒºL</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="quantity-container">
                                        <div class="value">{{ "%.2f" | format(lane.total_volume_ul) if lane.total_volume_ul is not none else "" }}</div>
                                        <div class="unit">ŒºL</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="quantity-container">
                                        <div class="value">{{ "%.3f" | format(lane.target_molarity) if lane.target_molarity is not none else "" }}</div>
                                        <div class="unit">nM</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="quantity-container">
                                        <div class="value">{{ "%.2f" | format(lane.phi_x) if lane.phi_x is not none else "" }}</div>
                                        <div class="unit">%</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
