{% from "components/pagination.jinja2" import pagination %}
{% from "components/table_col.jinja2" import table_col2 %}
{% from "components/spinner.jinja2" import spinner %}
{% from "components/tooltip.jinja2" import tooltip %}
{% from "components/contextmenu.jinja2" import context_menu %}
{% from "components/library_type_badge_list.jinja2" import library_type_badge_list %}

{% set experiment_lanes = experiment.lanes_map %}

<div id="experiment-pool-table" class="table-container">
    <div class="progress-bar-container flowcell-capacity-container pb-1 pt-1">
        {% if not can_edit_pooling %}
        {% set m_reads_used = experiment.m_reads_planned() %}
        {% set reads_used_pct = 100.0 * m_reads_used / experiment.flowcell_type.max_m_reads %}
        <div type="button" class="progress relative-progress flowcell-capacity-bar" role="progressbar" aria-valuenow="{{ reads_used_pct }}" aria-valuemin="0" aria-valuemax="100" style="height: 25px;"
        hx-get="{{ url_for('dist_reads_workflow.begin', experiment_id=experiment.id) }}" hx-target="#xl-modal-content" hx-swap="innerHTML" data-bs-toggle="modal" data-bs-target="#xl-modal">
            <div class="progress-title">
                <b>Flowcell</b> Capacity: {{ "%0.1f" % reads_used_pct }}% (Flowcell: <b>{{ experiment.flowcell_type.name }}</b> &mdash; {{ m_reads_used | int }}/{{ experiment.flowcell_type.max_m_reads }} Million Reads)
            </div>
            <div class="progress-bar progress-bar-striped text-dark {% if reads_used_pct <= 100 %}bg-cemm-blue{% else %}bg-cemm-red{% endif %}" style="width: {{ reads_used_pct }}%;">
            </div>  
        </div>
        {% else %}
        {% for lane in experiment.lanes %}
        {% set m_reads_used = lane.m_reads_planned() %}
        {% set reads_used_pct = 100.0 * m_reads_used / experiment.flowcell_type.max_m_reads_per_lane %}
        <div type="button" class="progress relative-progress flowcell-capacity-bar" role="progressbar" aria-valuenow="{{ reads_used_pct }}" aria-valuemin="0" aria-valuemax="100" style="height: 25px;"
        hx-get="{{ url_for('dist_reads_workflow.begin', experiment_id=experiment.id) }}" hx-target="#xl-modal-content" hx-swap="innerHTML" data-bs-toggle="modal" data-bs-target="#xl-modal">
            <div class="progress-title">
                <b>Lane {{ lane.number }}</b> Capacity: {{ "%0.1f" % reads_used_pct }}% (Flowcell: <b>{{ experiment.flowcell_type.name }}</b> &mdash; {{ m_reads_used | int }}/{{ experiment.flowcell_type.max_m_reads_per_lane }} Million Reads)
            </div>
            <div class="progress-bar progress-bar-striped text-dark {% if reads_used_pct <= 100 %}bg-cemm-blue{% else %}bg-cemm-red{% endif %}" style="width: {{ reads_used_pct }}%;">
            </div>  
        </div>
        {% endfor %}
        {% endif %}
    </div>
    <table class="table">
        <thead>
            <tr>
                {{ table_col2("experiment-pool-table", table, "id") }}
                {{ table_col2("experiment-pool-table", table, "name") }}
                <th scope="col" class="col-3">Lanes</th>
                {{ table_col2("experiment-pool-table", table, "library_types") }}
                {{ table_col2("experiment-pool-table", table, "status") }}
                <th class="col-1" scope="col"># Reads</th>
                <th class="col-1" scope="col" {{ tooltip("Sample molarity of the pool") }}>Molarity</th>
                {{ table_col2("experiment-pool-table", table, "num_libraries") }}
            </tr>
        </thead>
        <tbody>
            {% for pool in pools %}
            <tr>
                <th scope="row">{{ pool.id }}</th>
                <td class="cm-callback"
                {{
                    context_menu([
                        {"type": "copy", "value": pool.name, "label": "Copy Name"},
                        {"type": "hxdelete", "label": "Remove Pool", "disabled": false if current_user.is_admin() or experiment.status == ExperimentStatus.DRAFT else true, "config": {
                            "url": url_for('experiments_htmx.remove_pool', experiment_id=experiment.id, pool_id=pool.id, sort_by=sort_by, sort_order=sort_order),
                            "target": "#experiment-pool-table",
                            "title": "Remove {pool.name} from {experiment.name}?".format(pool=pool, experiment=experiment)
                        },}
                    ])
                }}>
                    <a href="{{ url_for('pools_page.pool', pool_id=pool.id, from='experiment@' + experiment.id | string) }}">
                        {{ pool.name }}{% if pool.clone_number > 0 %}<sup class="clone-number">(re:{{ pool.clone_number }})</sup>{% endif %}
                    </a>
                </td>
                <td class="x-scroll-cell">
                    <span class="scroll-container">
                        {% if not can_edit_pooling %}
                        <span class="table-btn" {{ tooltip("You cannot edit laning configurations in this workflow.", "top", category="warning") }}>
                        {% endif %}
                            <div class="btn-group table-btn {% if not can_edit_pooling %}disabled{% endif %}">
                                {% for lane_num in range(1, experiment.num_lanes + 1) %}
                                {% set lane, num_m_reads = pool.lane(lane_num) %}
                                {% if not can_edit_pooling %}
                                <button type="button" class="btn {% if pool.id in experiment_lanes[lane_num] %}btn-primary{% else %}btn-outline-primary{% endif %} table-btn disabled pool-lane-btn">
                                    {{ lane_num }}
                                </button>
                                {% else %}
                                {% if pool.id in experiment_lanes[lane_num] %}
                                {% set lane, num_m_reads = pool.lane(lane_num) %}
                                <button type="button" class="btn btn-primary table-btn pool-lane-btn"
                                hx-target="#experiment-pool-table" hx-swap="outerHTML"
                                hx-delete="{{ url_for('experiments_htmx.unlane_pool', experiment_id=experiment.id, pool_id=pool.id, lane_num=lane_num, sort_by=sort_by, sort_order=sort_order) }}">
                                    <span {{ tooltip("Reads: " + (num_m_reads or 0) | string) }}>
                                        {{ lane_num }}
                                    </span>
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-outline-primary table-btn pool-lane-btn"
                                hx-target="#experiment-pool-table" hx-swap="outerHTML"
                                hx-post="{{ url_for('experiments_htmx.lane_pool', experiment_id=experiment.id, pool_id=pool.id, lane_num=lane_num, sort_by=sort_by, sort_order=sort_order) }}">
                                    {{ lane_num }}
                                </button>
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                            </div>
                        {% if not can_edit_pooling %}
                        </span>
                        {% endif %}
                    </span>
                </td>
                <td class="x-scroll-cell">{{ library_type_badge_list(pool.library_types) }}</td>
                <td>{{ pool.status.icon }} {{ pool.status.name }}</td>
                <td>
                    <div class="quantity-container" {{ tooltip("Planned / Requested") }}>
                        <div class="value">{{ pool.reads_planned() | int }}/{{ pool.num_m_reads_requested | int if pool.num_m_reads_requested }}</div>
                        <div class="unit">M</div>
                    </div>
                </td>
                <td class="nm_total-col">
                    <div class="quantity-container {{ pool.molarity_color_class }}">
                        <div class="value">{{ pool.molarity_str }}</div>
                        <div class="unit">nM</div>
                    </div>
                </td>
                <td>{{ pool.num_libraries }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
