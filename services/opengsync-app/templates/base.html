{% from "components/spinner.jinja2" import spinner %}
{% from "components/tooltip.jinja2" import tooltip %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{{ url_for('static', filename='images/logo/opengsync_128.png') }}" sizes="any" type="image/png">

    <title>OpeNGSync</title>
    <!-- htmx -->
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js"></script>
    
    <!-- Sweet Alert 2 -->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4@4/bootstrap-4.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
     <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"/>

    <!-- Custom CSS --> 
    <link href="{{ url_for('static', filename='style/compiled/style.css') }}" rel="stylesheet" type="text/css"> 

    <!-- jspreadsheet -->
    <script src="{{ url_for('static', filename='js/jss-extended.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsuites/dist/jsuites.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsuites/dist/jsuites.min.css" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@5/dist/jspreadsheet.min.css" type="text/css" />

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.11"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>

    <script src="{{ url_for('static', filename='js/tooltips.js') }}"></script>
</head>

<body>
    <div style="position: absolute; bottom: 15px; left: 15px; z-index: 1100;">
        <a href="{{ url_for('help') }}" target="_blank" type="button" style="z-index: 1100;">
            <img src="{{ url_for('static', filename='images/help.svg') }}" width="26px" style="z-index: 1100;">
        </a>
    </div>
    {% if current_user.is_authenticated %}
        {% set user_role = current_user.role %}
    {% else %}
        {% set user_role = none %}
    {% endif %}
    <nav id="navbar" {% if current_user.is_authenticated and current_user.is_admin() %}class="admin"{% endif %}>
        <div class="nav-left">
            <div id="burger">
                <div class="line1"></div>
                <div class="line2"></div>
                <div class="line3"></div>
            </div>
            <a href="{{ url_for('dashboard') }}" id="icon-banner">
            {{ organization_name }}
            </a>
            {% if debug %}
            <i class="bi bi-bug" style="color: white;"></i>
            {% endif %}
        </div>
        <div id="navbar-container">
            <div class="nav-item">
                <a class="nav-link {{'active' if active_page == 'dashboard-page' else ''}}" id="dashboard-page" href="{{ url_for('dashboard') }}">Dashboard</a>
            </div>
            <div class="nav-item">
                <a class="nav-link {{'active' if active_page == 'projects-page' else ''}}" href="{{ url_for('projects_page.projects') }}">Projects</a>
            </div>
            <div class="nav-item">
                <a class="nav-link {{'active' if active_page == 'seq_requests-page' else ''}}" href="{{ url_for('seq_requests_page.seq_requests') }}">Requests</a>
            </div>
            {% if current_user.is_authenticated and current_user.is_insider() %}
            <div class="nav-item">
                <a class="nav-link {{'active' if active_page == 'lab_preps-page' else ''}}" href="{{ url_for('lab_preps_page.lab_preps') }}">Preps</a>
            </div>
            <div class="nav-item">
                <a class="nav-link {{'active' if active_page == 'experiments-page' else ''}}" href="{{ url_for('experiments_page.experiments') }}">Experiments</a>
            </div>
            <div class="nav-item nav-item-dropdown">
                <p>
                    Samples&nbsp;
                    <i class="bi bi-caret-down-fill" style="font-size: 10px;"></i>
                </p>
                <ul>
                    <li><a class="nav-link {{'active' if active_page == 'samples-page' else ''}}" href="{{ url_for('samples_page.samples') }}">Bio Samples</a></li>
                    <li><a class="nav-link {{'active' if active_page == 'libraries-page' else ''}}" href="{{ url_for('libraries_page.libraries') }}">Libraries</a></li>
                    <li><a class="nav-link {{'active' if active_page == 'pools-page' else ''}}" href="{{ url_for('pools_page.pools') }}">Pools</a></li>
                </ul>
            </div>
            <div class="nav-item">
                <a class="nav-link {{'active' if active_page == 'users-page' else ''}}" href="{{ url_for('users_page.users') }}">Users</a>
            </div>
            {% endif %}
            <div class="nav-item nav-item-dropdown">
                <p>
                    Kits&nbsp;
                    <i class="bi bi-caret-down-fill" style="font-size: 10px;"></i>
                </p>
                <ul>
                    {% if current_user.is_authenticated and current_user.is_insider() %}
                    <li><a class="nav-link {{'active' if active_page == 'kits-page' else ''}}" href="{{ url_for('kits_page.kits') }}">Kits</a></li>
                    <li><a class="nav-link {{'active' if active_page == 'protocols-page' else ''}}" href="{{ url_for('protocols_page.protocols') }}">Protocols</a></li>
                    {% endif %}
                    <li><a class="nav-link {{'active' if active_page == 'barcodes-page' else ''}}" href="{{ url_for('kits_page.index_kits') }}">Barcodes</a></li>
                    <li><a class="nav-link {{'active' if active_page == 'feature_kits-page' else ''}}" href="{{ url_for('kits_page.feature_kits') }}">Features</a></li>
                </ul>
            </div>
            {% if current_user.is_authenticated %}
            <div class="nav-item">
                <a class="nav-link {{'active' if active_page == 'groups-page' else ''}}" href="{{ url_for('groups_page.groups') }}">Groups</a>
            </div>
            {% endif %}
            {% if current_user.is_authenticated and not current_user.is_insider() %}
            <div class="nav-item">
                <a class="nav-link {{'active' if active_page == 'help-page' else ''}}" href="{{ url_for('help') }}">Help</a>
            </div>
            {% endif %}
            {% if current_user.is_authenticated and current_user.is_insider() %}
            <div class="nav-item">
                <a class="nav-link {{'active' if active_page == 'seq_run-page' else ''}}" href="{{ url_for('seq_runs_page.seq_runs') }}">Runs</a>
            </div>
            <div class="nav-item">
                <a class="nav-link {{'active' if active_page == 'browser-page' else ''}}" href="{{ url_for('browser_page.files') }}">Files</a>
            </div>
            {% if user_role == UserRole.ADMIN  %}
            <div class="nav-item nav-item-dropdown">
                <p>
                    Admin&nbsp;
                    <i class="bi bi-caret-down-fill" style="font-size: 10px;"></i>
                </p>
                <ul>
                    <li><a class="nav-link {{'active' if active_page == 'share_token-page' else ''}}" href="{{ url_for('share_tokens_page.share_tokens') }}">Share</a></li>
                    <li><a class="nav-link {{'active' if active_page == 'devices-page' else ''}}" href="{{ url_for('devices_page.devices') }}">Devices</a></li>
                    <li><a class="nav-link {{'active' if active_page == 'admin-page' else ''}}" href="{{ url_for('admin_pages.admin_page') }}">Admin</a></li>
                </ul>
            </div>
            {% endif %}
            {% endif %}
        </div>
        <div class="nav-right">
            {% if current_user.is_authenticated %}
            <a type="button" class="btn btn-secondary login-btn user-btn" href="{{ url_for('auth_page.auth') }}">
                <p>
                    {% if user_role == UserRole.ADMIN %}
                    <i class="bi bi-wrench-adjustable-circle"></i>
                    {% elif user_role == UserRole.BIOINFORMATICIAN %}
                    <i class="bi bi-cpu"></i>
                    {% elif user_role == UserRole.TECHNICIAN %}
                    <i class="bi bi-virus2"></i>
                    {% elif user_role == UserRole.CLIENT %}
                    <i class="bi bi-person-fill"></i>
                    {% endif %}
                    {{ current_user.last_name }}
                </p>
            </a>
            {% else %}
            <a type="button" class="btn btn-secondary login-btn" href="{{ url_for('auth_page.auth') }}">
                <p>
                    <i class="bi bi-box-arrow-in-right"></i> Sign In
                </p>
            </a>
            {% endif %}
        </div>
    </nav>
    {% include "components/right_click_menu.html" %}
    <div id="alert-container"></div>
    <div id="debug-container"></div>
    <div id="main-container">
        <div id="main">
            <div id="left-margin">
                <nav id="breadcrumb" aria-label="breadcrumb">
                    <ol>
                    {% for name, url in path_list %}
                        {% if loop.last %}
                            <li  class="active" aria-current="page">{{name}}</li>
                        {% else %}
                            <li><a href="{{ url }}">{{name}}</a></li>
                        {% endif %}
                    {% endfor %}
                    </ol>
                </nav>
            </div>
            <div id="middle-container">
            {% block content %}{% endblock %}
            </div>
            <div id="right-margin">
            </div>
        </div>
    </div>

    <div class="modal fade" id="sm-modal" aria-hidden="true" tabindex="-1" data-bs-keyboard="false" data-bs-backdrop="static">
        <div class="modal-dialog modal-sm modal-fullscreen-sm-down modal-dialog-centered" id="sm-modal-content">
            {{ spinner() }}
        </div>
    </div>

    <div class="modal fade" id="xl-modal" aria-hidden="true" tabindex="-1" data-bs-keyboard="false" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-fullscreen-xl-down modal-dialog-centered" id="xl-modal-content">
            {{ spinner() }}
        </div>
    </div>

    <div class="modal fade" id="fullscreen-modal" aria-hidden="true" tabindex="-1" data-bs-keyboard="false" data-bs-backdrop="static">
        <div class="modal-dialog modal-fullscreen modal-dialog-centered" id="fullscreen-modal-content">
            {{ spinner() }}
        </div>
    </div>

    <div id="debug-modal" aria-hidden="true" style="display: none;">
    </div>

    <div class="toast" id="cookie-toast" role="alert" aria-live="assertive" aria-atomic="true" style="display: none;">
        <div class="toast-header">
            <strong class="me-auto">üç™ Cookies Notice</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            This website uses only essential cookies to ensure the proper functionality of the website.
            We do not use any tracking or marketing cookies.
            By continuing to use this website, you consent to the use of these essential cookies.
        </div>
    </div>

    <script type="text/javascript">
        $(document).on("click", "#right-click-bg", function(e) {
            $("#context-menu-container").css({
                display: "none"
            }).children().remove();
            $("#right-click-bg").css({
                display: "none"
            });
        });

        $(document).keyup(function(e) {
            if (e.key === "Escape") {
                $("#context-menu-container").css({
                    display: "none"
                }).empty();
                $("#right-click-bg").css({
                    display: "none"
                });
            }
        });

        function render_flash_messages() {
            $.ajax({
                url: "{{ url_for('retrieve_flash_messages') }}",
                type: "GET"
            }).done(function(data) {
                let messages = Array.isArray(data) ? data : (data && data.messages ? data.messages : []);
                if (!messages.length) {
                    return;
                }
                showOneFlashFromList(messages, 0);
            });
        }

        function showOneFlashFromList(messages, index) {
            if (index >= messages.length) {
                return;  // No more messages
            }
            const msg = messages[index];
            Swal.fire({
                position: 'top',
                icon: msg.category || 'success',
                html: `<div style="display: flex; justify-content: center; align-items: center; height: 100%; padding: 0; font-weight: 600;">${msg.message}</div>`,
                showConfirmButton: false,
                timer: msg.category === 'error' ? null : 1000,
                toast: true,
                showCloseButton: true,
                willClose: function() {
                    showOneFlashFromList(messages, index + 1);
                }
            });
        }

        function print_div(id) {
            var div = document.getElementById(id);

            var win = window.open("", "Print-Window");

            win.document.open();
            const css = `<link href="{{ url_for('static', filename='style/compiled/style.css') }}" rel="stylesheet" type="text/css">`;
            win.document.write('<html><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"></head>' + css + '<body onload="window.print()" class="print-window">' + div.innerHTML + '</body></html>');

            win.document.close();

            setTimeout(function () {
                win.close();
            }, 1000);
        }

        // responsive navbar
        $("#burger").on("click", function () {
            $("#navbar-container").toggleClass("nav-active");
            $("#navbar-container .nav-item").each(function (index) {
                $(this).css({
                    animation: 'none'
                });
            });
            $("#navbar-container.nav-active .nav-item").each(function (index) {
                $(this).css({
                    animation: `navLinkFade 0.5s ease forwards ${index * 0.08 + 0.3}s`
                });
            });

            $("#burger").toggleClass("toggle");
        });

        function open_file_tab(file_id, container_id="files-tab") {
            $(`.nav-tabs button[data-bs-target="#${container_id}"]`).tab('show');
            $(`.nav-tabs button[data-bs-target="#file-${file_id}-tab"]`).tab('show');
        }
        $(document).ready(function() {
            render_flash_messages();
        });
    </script>

    <script src="{{ url_for('static', filename='js/searchbar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/contextmenu.js') }}"></script>
    <script src="{{ url_for('static', filename='js/reverse_complement.js') }}"></script>
    <script src="{{ url_for('static', filename='js/confirm_close.js') }}"></script>
    <script src="{{ url_for('static', filename='js/flask-table.js') }}"></script>
    <script src="{{ url_for('static', filename='js/colors.js') }}"></script>
    <script src="{{ url_for('static', filename='js/cookie.js') }}"></script>
    <script src="{{ url_for('static', filename='js/nav.js') }}"></script>
    <script src="{{ url_for('static', filename='js/univer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/libs.js') }}"></script>
    <script src="{{ url_for('static', filename='js/callbacks.js') }}"></script>
</body>

</html>