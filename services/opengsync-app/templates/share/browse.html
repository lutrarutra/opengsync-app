<!DOCTYPE html>
<html>
    <head>
        <title>Index of {{ current_path.as_posix() if current_path else '/' }}</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            table { width: 100%; border-collapse: collapse; }
            th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
            th { background-color: #f2f2f2; }
            a { text-decoration: none; color: #0066cc; }
            a:hover { text-decoration: underline; }
            .breadcrumb { margin-bottom: 20px; }
            a:visited { color: #551a8b; }
        </style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"/>
    </head>
    <body>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Size</th>
                    <th>Last Modified</th>
                </tr>
            </thead>
            <tbody>
                {% if current_path.parts %}
                <tr>
                    <td><a href="{{ url_for('file_share.browse', token=token, subpath=parent_dir.as_posix() if parent_dir else '') }}">../</a></td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                {% endif %}
                {% for path in paths %}
                {% set stat = path.stat() %}
                <tr>
                    <td>
                        <a href="{{ url_for('file_share.browse', token=token, subpath=(current_path / path.name).as_posix() if current_path else path.name) }}">
                            {% if path.is_file() %}
                            <i class="bi bi-file-earmark"></i> {{ path.name }}
                            {% else %}
                            <i class="bi bi-archive"></i> {{ path.name }}/
                            {% endif %}
                        </a>
                    </td>
                    <td>{{ stat.st_size | bytes_to_human }}</td>
                    <td>{{ stat.st_mtime | from_timestamp }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <script>
            function render_flash_messages() {
                $.ajax({
                    url: "{{ url_for('retrieve_flash_messages') }}",
                    type: "GET"
                }).done(function(data) {
                    let messages = Array.isArray(data) ? data : (data && data.messages ? data.messages : []);
                    if (!messages.length) {
                        return;
                    }
                    showOneFlashFromList(messages, 0);
                });
            }

            function showOneFlashFromList(messages, index) {
                if (index >= messages.length) {
                    return;
                }
                const msg = messages[index];
                Swal.fire({
                    position: 'top',
                    icon: msg.category || 'success',
                    html: `<div style="display: flex; justify-content: center; align-items: center; height: 100%; padding: 0; font-weight: 600;">${msg.message}</div>`,
                    showConfirmButton: false,
                    timer: msg.category === 'error' ? null : 1000,
                    toast: true,
                    showCloseButton: true,
                    willClose: function() {
                        showOneFlashFromList(messages, index + 1);
                    }
                });
            }
            document.addEventListener('DOMContentLoaded', function() {
                render_flash_messages();
            });
        </script>
    </body>
</html>